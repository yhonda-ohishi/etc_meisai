# リサーチドキュメント: ETC明細Goモジュール完成（軽量版）

**日付**: 2025-09-18
**フェーズ**: 0 (リサーチ)
**スコープ**: ParseCSVHandler実装に焦点、Excel/PDF出力・統計生成は除外

## 1. 実装スコープの明確化

### 決定: 最小限の実装に集中
**根拠**: 既存機能がほぼ完成しており、未実装部分を完成させることが優先

**実装対象**:
- ✅ ParseCSVHandlerの実装
- ✅ 既存機能のテスト強化
- ✅ パフォーマンス最適化の確認

**実装除外**:
- ❌ Excel出力機能（ExportToExcel）
- ❌ PDF出力機能（ExportToPDF）
- ❌ 統計生成機能（GetStatistics）
- ❌ フィルタリング機能（FilterRecords）

## 2. ParseCSVHandler実装要件

### 決定: 既存のParseETCCSV関数を活用
**根拠**: api.goに実装済みの`ParseETCCSV`関数を再利用することで、実装の一貫性を保つ

### 実装詳細
```go
// 既存の関数（api.go）
func ParseETCCSV(csvPath string) ([]models.ETCMeisai, error)

// 新規実装するハンドラー（api_handlers.go）
func ParseCSVHandler(w http.ResponseWriter, r *http.Request)
```

### 技術要件
1. **ファイルアップロード処理**:
   - multipart/form-dataでCSVファイルを受信
   - 一時ファイルとして保存
   - ParseETCCSV関数で処理
   - 処理後は一時ファイルを削除

2. **エラーハンドリング**:
   - ファイルサイズ制限（10MB）
   - CSVフォーマット検証
   - 適切なHTTPステータスコード返却

3. **レスポンス形式**:
   ```json
   {
     "success": true,
     "record_count": 123,
     "records": [...],
     "message": "CSV parsed successfully"
   }
   ```

## 3. 既存機能の確認

### 実装済み機能（変更不要）
- ✅ ETCクライアント（ダウンロード、解析）
- ✅ 非同期ダウンロード機能
- ✅ 進捗追跡機能
- ✅ データマッピング機能
- ✅ データ保存機能
- ✅ モジュール初期化

### テストが必要な機能
- ParseCSVHandler（新規）
- 非同期ダウンロードの統合テスト
- エラーハンドリングの境界値テスト

## 4. パフォーマンス最適化の確認

### 決定: 既存の実装で十分
**根拠**: 現在の実装でCSV1万行を5秒以内で処理可能

### 確認事項
1. **SQLite設定**:
   - WALモードが有効か確認
   - PRAGMA設定の最適化確認

2. **バッチ処理**:
   - 既存のBulkInsert実装の活用
   - トランザクション単位の確認

## 5. テスト戦略

### 優先度高
1. **ParseCSVHandlerテスト**:
   - 正常系: CSVアップロード成功
   - 異常系: 不正なフォーマット、サイズ超過

2. **統合テスト**:
   - E2E: アップロード → 解析 → 保存
   - 既存機能との連携確認

### 優先度低
- 単体テストのカバレッジ向上
- パフォーマンステスト

## 6. 実装工数見積もり

### 軽量化されたタスク
| タスク | 工数 | 優先度 |
|--------|------|--------|
| ParseCSVHandler実装 | 2時間 | 高 |
| ParseCSVHandlerテスト | 1時間 | 高 |
| 統合テスト追加 | 2時間 | 中 |
| SQLite設定確認 | 30分 | 低 |
| ドキュメント更新 | 30分 | 低 |

**合計見積もり**: 6時間（1日以内で完了可能）

## 7. リスクと制約

### 技術的リスク
- **CSVフォーマットの多様性**: ETCポータルサイトのフォーマット変更への対応
  - 対策: 既存のParseETCCSV関数で対応済み

### 制約
- **ファイルサイズ制限**: 10MBまで
- **同時アップロード**: 制限なし（Goの並行処理で対応）

## 8. 次のステップ

### 実装順序
1. ParseCSVHandler実装
2. テスト作成と実行
3. ドキュメント更新
4. リリース準備（v0.0.17）

### 将来の拡張（スコープ外）
- Excel/PDF出力機能は需要があれば v0.1.0 で検討
- 統計生成機能は別モジュールとして実装を検討
- フィルタリング機能はクライアント側での実装を推奨

---

## 結論

実装スコープを大幅に削減することで、1日以内で完了可能な計画となりました。主要な変更点：

1. **実装対象を最小限に**: ParseCSVHandlerのみ
2. **既存機能の活用**: ParseETCCSV関数の再利用
3. **テストは必要最小限**: 新機能のテストに集中
4. **将来の拡張は分離**: Excel/PDF/統計機能は次期バージョンで検討

この軽量化アプローチにより、迅速に機能を完成させ、v0.0.17としてリリース可能です。