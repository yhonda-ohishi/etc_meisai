openapi: 3.0.3
info:
  title: ETC明細 実データマッチング API
  description: |
    ETC明細システムで本番dtakoデータベースとの実データマッチング機能を提供するAPIです。
    ETCカード番号(etc_num)を基にした多段階マッチングアルゴリズムを実装しています。
  version: 1.0.0
  contact:
    name: ETC明細システム開発チーム
    email: etc-dev@company.com

servers:
  - url: http://localhost:8080/api/etc
    description: ローカル開発環境
  - url: https://api-etc.company.com/api/etc
    description: 本番環境

tags:
  - name: real-matching
    description: 実データマッチング関連
  - name: mapping-management
    description: マッピング管理
  - name: batch-processing
    description: バッチ処理

paths:
  /real-match/auto:
    post:
      tags:
        - real-matching
      summary: 自動マッチング実行
      description: |
        指定されたETC明細レコードに対して本番dtakoデータベースとの自動マッチングを実行します。
        多段階マッチングアルゴリズム（完全一致→近似マッチング→候補抽出）を適用します。
      operationId: executeAutoMatching
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/AutoMatchingRequest'
            examples:
              single_record:
                summary: 単一レコードマッチング
                value:
                  etc_meisai_ids: [12345]
                  matching_mode: "auto_exact"
                  create_mapping: true
              batch_processing:
                summary: バッチ処理
                value:
                  date_from: "2025-09-01"
                  date_to: "2025-09-18"
                  etc_num_filter: "1234567890123456"
                  matching_mode: "multi_stage"
                  create_mapping: true
                  batch_size: 1000
      responses:
        '200':
          description: マッチング処理完了
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/MatchingResponse'
        '202':
          description: バッチ処理開始（非同期）
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/BatchJobResponse'
        '400':
          description: リクエストエラー
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '500':
          description: サーバーエラー
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /real-match/by-etc-num/{etc_num}:
    post:
      tags:
        - real-matching
      summary: ETCカード番号指定マッチング
      description: |
        指定されたETCカード番号のETC明細レコード全てに対してマッチングを実行します。
      operationId: matchByETCNum
      parameters:
        - name: etc_num
          in: path
          required: true
          description: ETCカード番号
          schema:
            type: string
            pattern: '^[0-9]{16}$'
          example: "1234567890123456"
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ETCNumMatchingRequest'
      responses:
        '200':
          description: マッチング処理完了
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/MatchingResponse'
        '400':
          description: リクエストエラー
        '404':
          description: 指定されたETCカード番号のレコードが見つからない

  /real-match/candidates/{etc_meisai_id}:
    get:
      tags:
        - real-matching
      summary: マッチング候補取得
      description: |
        指定されたETC明細IDに対するdtako_rowsの候補リストを取得します。
      operationId: getMatchingCandidates
      parameters:
        - name: etc_meisai_id
          in: path
          required: true
          description: ETC明細ID
          schema:
            type: integer
            format: int64
        - name: max_candidates
          in: query
          description: 最大候補数
          schema:
            type: integer
            default: 10
            minimum: 1
            maximum: 50
        - name: time_tolerance
          in: query
          description: 時間許容範囲（分）
          schema:
            type: integer
            default: 30
            minimum: 0
            maximum: 120
      responses:
        '200':
          description: 候補リスト取得成功
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/CandidatesResponse'

  /mapping/real-data:
    post:
      tags:
        - mapping-management
      summary: 実データマッピング作成
      description: |
        ETC明細とdtako_rowsの手動マッピングを作成します。
      operationId: createRealDataMapping
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CreateMappingRequest'
      responses:
        '201':
          description: マッピング作成成功
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/MappingResponse'
        '409':
          description: マッピングが既に存在

    get:
      tags:
        - mapping-management
      summary: 実データマッピング一覧取得
      description: |
        実データマッピングの一覧をページネーション付きで取得します。
      operationId: listRealDataMappings
      parameters:
        - name: page
          in: query
          description: ページ番号
          schema:
            type: integer
            default: 1
            minimum: 1
        - name: limit
          in: query
          description: 1ページあたりの件数
          schema:
            type: integer
            default: 20
            minimum: 1
            maximum: 100
        - name: mapping_type
          in: query
          description: マッピングタイプでフィルタ
          schema:
            type: string
            enum: [manual, auto_exact, auto_partial, auto_candidate]
        - name: etc_num
          in: query
          description: ETCカード番号でフィルタ
          schema:
            type: string
            pattern: '^[0-9]{16}$'
      responses:
        '200':
          description: マッピング一覧取得成功
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/MappingListResponse'

  /mapping/real-data/{mapping_id}:
    get:
      tags:
        - mapping-management
      summary: マッピング詳細取得
      description: |
        指定されたマッピングIDの詳細情報を取得します。
      operationId: getRealDataMapping
      parameters:
        - name: mapping_id
          in: path
          required: true
          description: マッピングID
          schema:
            type: integer
            format: int64
      responses:
        '200':
          description: マッピング詳細取得成功
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/MappingDetailResponse'
        '404':
          description: マッピングが見つからない

    put:
      tags:
        - mapping-management
      summary: マッピング更新
      description: |
        指定されたマッピングを更新します。
      operationId: updateRealDataMapping
      parameters:
        - name: mapping_id
          in: path
          required: true
          description: マッピングID
          schema:
            type: integer
            format: int64
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/UpdateMappingRequest'
      responses:
        '200':
          description: マッピング更新成功
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/MappingResponse'

    delete:
      tags:
        - mapping-management
      summary: マッピング削除
      description: |
        指定されたマッピングを削除します。
      operationId: deleteRealDataMapping
      parameters:
        - name: mapping_id
          in: path
          required: true
          description: マッピングID
          schema:
            type: integer
            format: int64
      responses:
        '204':
          description: マッピング削除成功
        '404':
          description: マッピングが見つからない

  /batch/real-match:
    post:
      tags:
        - batch-processing
      summary: バッチマッチング開始
      description: |
        大量のETC明細レコードに対してバッチマッチング処理を開始します。
      operationId: startBatchMatching
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/BatchMatchingRequest'
      responses:
        '202':
          description: バッチ処理開始
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/BatchJobResponse'

  /batch/jobs/{job_id}:
    get:
      tags:
        - batch-processing
      summary: バッチジョブステータス取得
      description: |
        指定されたバッチジョブの実行状況を取得します。
      operationId: getBatchJobStatus
      parameters:
        - name: job_id
          in: path
          required: true
          description: ジョブID
          schema:
            type: string
            format: uuid
      responses:
        '200':
          description: ジョブステータス取得成功
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/BatchJobStatusResponse'
        '404':
          description: ジョブが見つからない

  /batch/jobs/{job_id}/results:
    get:
      tags:
        - batch-processing
      summary: バッチジョブ結果取得
      description: |
        完了したバッチジョブの詳細結果を取得します。
      operationId: getBatchJobResults
      parameters:
        - name: job_id
          in: path
          required: true
          description: ジョブID
          schema:
            type: string
            format: uuid
        - name: page
          in: query
          description: ページ番号
          schema:
            type: integer
            default: 1
        - name: limit
          in: query
          description: 1ページあたりの結果数
          schema:
            type: integer
            default: 100
      responses:
        '200':
          description: ジョブ結果取得成功
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/BatchJobResultsResponse'

components:
  schemas:
    AutoMatchingRequest:
      type: object
      description: 自動マッチングリクエスト
      properties:
        etc_meisai_ids:
          type: array
          items:
            type: integer
            format: int64
          description: 対象ETC明細IDリスト
          maxItems: 1000
        date_from:
          type: string
          format: date
          description: 対象期間開始日
        date_to:
          type: string
          format: date
          description: 対象期間終了日
        etc_num_filter:
          type: string
          pattern: '^[0-9]{16}$'
          description: ETCカード番号フィルタ
        matching_mode:
          type: string
          enum: [auto_exact, auto_partial, multi_stage, candidates_only]
          description: マッチングモード
          default: multi_stage
        create_mapping:
          type: boolean
          description: マッチング成功時にマッピング自動作成
          default: true
        batch_size:
          type: integer
          description: バッチサイズ
          default: 1000
          minimum: 1
          maximum: 10000
      anyOf:
        - required: [etc_meisai_ids]
        - required: [date_from, date_to]

    ETCNumMatchingRequest:
      type: object
      description: ETCカード番号指定マッチングリクエスト
      required:
        - date_from
        - date_to
      properties:
        date_from:
          type: string
          format: date
          description: 対象期間開始日
        date_to:
          type: string
          format: date
          description: 対象期間終了日
        matching_mode:
          type: string
          enum: [auto_exact, auto_partial, multi_stage]
          default: multi_stage
        create_mapping:
          type: boolean
          default: true

    CreateMappingRequest:
      type: object
      description: マッピング作成リクエスト
      required:
        - etc_meisai_id
        - dtako_row_id
        - mapping_type
      properties:
        etc_meisai_id:
          type: integer
          format: int64
          description: ETC明細ID
        dtako_row_id:
          type: string
          description: dtako行ID
        vehicle_id:
          type: string
          description: 車両ID
        mapping_type:
          type: string
          enum: [manual, auto_exact, auto_partial, auto_candidate]
          description: マッピングタイプ
        notes:
          type: string
          maxLength: 500
          description: 備考
        created_by:
          type: string
          description: 作成者

    UpdateMappingRequest:
      type: object
      description: マッピング更新リクエスト
      properties:
        vehicle_id:
          type: string
          description: 車両ID
        notes:
          type: string
          maxLength: 500
          description: 備考

    BatchMatchingRequest:
      type: object
      description: バッチマッチングリクエスト
      required:
        - date_from
        - date_to
      properties:
        date_from:
          type: string
          format: date
          description: 対象期間開始日
        date_to:
          type: string
          format: date
          description: 対象期間終了日
        etc_num_filter:
          type: string
          pattern: '^[0-9]{16}$'
          description: ETCカード番号フィルタ
        vehicle_id_filter:
          type: string
          description: 車両IDフィルタ
        batch_size:
          type: integer
          default: 1000
          minimum: 100
          maximum: 5000
        max_goroutines:
          type: integer
          default: 5
          minimum: 1
          maximum: 10
        auto_create_mapping:
          type: boolean
          default: true

    MatchingResponse:
      type: object
      description: マッチングレスポンス
      required:
        - success
        - processed_count
        - results
      properties:
        success:
          type: boolean
        processed_count:
          type: integer
        matched_count:
          type: integer
        candidate_count:
          type: integer
        no_match_count:
          type: integer
        error_count:
          type: integer
        processing_time_ms:
          type: integer
        results:
          type: array
          items:
            $ref: '#/components/schemas/MatchingResult'

    MatchingResult:
      type: object
      description: 個別マッチング結果
      required:
        - etc_meisai_id
        - status
      properties:
        etc_meisai_id:
          type: integer
          format: int64
        status:
          type: string
          enum: [matched, candidates, no_match, error]
        matched_dtako_row:
          $ref: '#/components/schemas/DtakoRow'
        candidate_rows:
          type: array
          items:
            $ref: '#/components/schemas/DtakoRow'
        confidence_score:
          type: number
          format: float
          minimum: 0.0
          maximum: 1.0
        matching_type:
          type: string
          enum: [exact, partial, candidate]
        error_message:
          type: string
        processed_at:
          type: string
          format: date-time

    DtakoRow:
      type: object
      description: dtako行データ
      required:
        - dtako_row_id
        - start_time
        - end_time
        - vehicle_id
        - etc_num
      properties:
        dtako_row_id:
          type: string
        start_time:
          type: string
          format: date-time
        end_time:
          type: string
          format: date-time
        vehicle_id:
          type: string
        etc_num:
          type: string
          pattern: '^[0-9]{16}$'
        driver_id:
          type: string
        route_info:
          type: string
        distance:
          type: number
          format: float
        created_at:
          type: string
          format: date-time

    CandidatesResponse:
      type: object
      description: 候補レスポンス
      required:
        - etc_meisai_id
        - candidates
      properties:
        etc_meisai_id:
          type: integer
          format: int64
        etc_data:
          $ref: '#/components/schemas/ETCMeisai'
        candidates:
          type: array
          items:
            $ref: '#/components/schemas/CandidateRow'
        total_candidates:
          type: integer
        search_parameters:
          $ref: '#/components/schemas/SearchParameters'

    CandidateRow:
      allOf:
        - $ref: '#/components/schemas/DtakoRow'
        - type: object
          properties:
            match_score:
              type: number
              format: float
              minimum: 0.0
              maximum: 1.0
            match_reasons:
              type: array
              items:
                type: string
            time_difference_minutes:
              type: integer

    SearchParameters:
      type: object
      description: 検索パラメータ
      properties:
        time_tolerance_minutes:
          type: integer
        exact_etc_num_match:
          type: boolean
        vehicle_id_filter:
          type: string

    ETCMeisai:
      type: object
      description: ETC明細データ
      properties:
        id:
          type: integer
          format: int64
        usage_date:
          type: string
          format: date
        entry_ic:
          type: string
        exit_ic:
          type: string
        vehicle_num:
          type: string
        etc_card_no:
          type: string
        entry_time:
          type: string
        exit_time:
          type: string
        total_charge:
          type: integer
        unko_no:
          type: string

    MappingResponse:
      type: object
      description: マッピングレスポンス
      required:
        - success
        - mapping
      properties:
        success:
          type: boolean
        mapping:
          $ref: '#/components/schemas/ETCDtakoMapping'
        message:
          type: string

    ETCDtakoMapping:
      type: object
      description: ETCデジタコマッピング
      required:
        - id
        - etc_meisai_id
        - dtako_row_id
        - mapping_type
        - created_at
        - updated_at
      properties:
        id:
          type: integer
          format: int64
        etc_meisai_id:
          type: integer
          format: int64
        dtako_row_id:
          type: string
        vehicle_id:
          type: string
        mapping_type:
          type: string
          enum: [manual, auto_exact, auto_partial, auto_candidate]
        notes:
          type: string
        created_at:
          type: string
          format: date-time
        updated_at:
          type: string
          format: date-time
        created_by:
          type: string

    MappingDetailResponse:
      type: object
      description: マッピング詳細レスポンス
      required:
        - mapping
        - etc_data
        - dtako_data
      properties:
        mapping:
          $ref: '#/components/schemas/ETCDtakoMapping'
        etc_data:
          $ref: '#/components/schemas/ETCMeisai'
        dtako_data:
          $ref: '#/components/schemas/DtakoRow'

    MappingListResponse:
      type: object
      description: マッピング一覧レスポンス
      required:
        - mappings
        - total_count
        - page
        - page_size
      properties:
        mappings:
          type: array
          items:
            $ref: '#/components/schemas/ETCDtakoMapping'
        total_count:
          type: integer
        page:
          type: integer
        page_size:
          type: integer

    BatchJobResponse:
      type: object
      description: バッチジョブレスポンス
      required:
        - job_id
        - status
      properties:
        job_id:
          type: string
          format: uuid
        status:
          type: string
          enum: [queued, processing, completed, failed]
        message:
          type: string

    BatchJobStatusResponse:
      type: object
      description: バッチジョブステータスレスポンス
      required:
        - job_id
        - status
        - total_records
        - processed_count
        - start_time
      properties:
        job_id:
          type: string
          format: uuid
        status:
          type: string
          enum: [queued, processing, completed, failed]
        total_records:
          type: integer
        processed_count:
          type: integer
        matched_count:
          type: integer
        candidate_count:
          type: integer
        error_count:
          type: integer
        start_time:
          type: string
          format: date-time
        end_time:
          type: string
          format: date-time
        estimated_completion:
          type: string
          format: date-time
        progress_percentage:
          type: integer
          minimum: 0
          maximum: 100

    BatchJobResultsResponse:
      type: object
      description: バッチジョブ結果レスポンス
      required:
        - job_id
        - results
        - total_results
        - page
        - page_size
      properties:
        job_id:
          type: string
          format: uuid
        results:
          type: array
          items:
            $ref: '#/components/schemas/MatchingResult'
        total_results:
          type: integer
        page:
          type: integer
        page_size:
          type: integer

    ErrorResponse:
      type: object
      description: エラーレスポンス
      required:
        - error
        - message
      properties:
        error:
          type: string
          description: エラーコード
        message:
          type: string
          description: エラーメッセージ
        details:
          type: object
          description: エラー詳細
        timestamp:
          type: string
          format: date-time