openapi: 3.0.3
info:
  title: マッピング管理API
  description: |
    ETC明細とDtako行の紐付け管理機能を提供するAPI

    ## 主な機能
    - **マッピング作成**: ETC明細とDtako行の新規紐付け
    - **マッピング検索**: 各種条件でのマッピング検索
    - **マッピング更新**: 既存マッピングの修正
    - **マッピング削除**: 不要なマッピングの削除
    - **未紐付けデータ管理**: 未処理のETC明細の取得

    ## マッピングタイプ
    - **auto**: 自動生成されたマッピング
    - **manual**: 手動で作成されたマッピング

  version: 1.0.0

paths:
  /api/etc/mapping:
    post:
      summary: ETC明細とDtako行のマッピングを作成
      description: |
        ETC明細とDtako行の新しいマッピングを作成します。
        既存のマッピングがある場合は409エラーを返します。
      tags:
        - Mapping Management
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ETCDtakoMappingRequest'
            examples:
              manual_mapping:
                summary: 手動マッピング作成
                value:
                  etc_meisai_id: 12345
                  dtako_row_id: "DT-2025-001-001"
                  vehicle_id: "V001"
                  mapping_type: "manual"
                  notes: "手動で紐付けしました"
                  created_by: "user123"
              auto_mapping:
                summary: 自動マッピング作成
                value:
                  etc_meisai_id: 12346
                  dtako_row_id: "DT-2025-001-002"
                  vehicle_id: "V002"
                  mapping_type: "auto"
                  created_by: "system"
      responses:
        '201':
          description: マッピング作成成功
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ETCDtakoMappingResponse'
              example:
                success: true
                mapping:
                  id: 1
                  etc_meisai_id: 12345
                  dtako_row_id: "DT-2025-001-001"
                  vehicle_id: "V001"
                  mapping_type: "manual"
                  notes: "手動で紐付けしました"
                  created_at: "2025-01-13T15:04:05Z"
                  updated_at: "2025-01-13T15:04:05Z"
                  created_by: "user123"
                message: "Mapping created successfully"
        '400':
          description: 不正なリクエスト
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ETCDtakoMappingResponse'
              example:
                success: false
                message: "Invalid request body: missing required field etc_meisai_id"
        '409':
          description: マッピングが既に存在
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ETCDtakoMappingResponse'
              example:
                success: false
                message: "Mapping already exists for this combination"
        '500':
          description: サーバーエラー
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ETCDtakoMappingResponse'
              example:
                success: false
                message: "Database connection failed"

  /api/etc/mapping/{id}:
    get:
      summary: IDでマッピングを取得
      description: 指定されたIDのマッピングを取得します
      tags:
        - Mapping Management
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: integer
            format: int64
          description: マッピングID
          example: 1
      responses:
        '200':
          description: マッピング情報
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ETCDtakoMapping'
        '400':
          description: 不正なIDフォーマット
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ETCDtakoMappingResponse'
              example:
                success: false
                message: "Invalid ID format"
        '404':
          description: マッピングが見つからない
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ETCDtakoMappingResponse'
              example:
                success: false
                message: "Mapping not found"

    put:
      summary: マッピングを更新
      description: |
        指定されたIDのマッピングを更新します。
        更新可能なフィールドは vehicle_id と notes のみです。
      tags:
        - Mapping Management
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: integer
            format: int64
          description: マッピングID
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                vehicle_id:
                  type: string
                  description: 車両ID
                notes:
                  type: string
                  description: 備考
            example:
              vehicle_id: "V003"
              notes: "車両情報を修正しました"
      responses:
        '200':
          description: 更新成功
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ETCDtakoMappingResponse'
        '400':
          description: 不正なリクエスト
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ETCDtakoMappingResponse'
        '404':
          description: マッピングが見つからない
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ETCDtakoMappingResponse'

    delete:
      summary: マッピングを削除
      description: 指定されたIDのマッピングを削除します
      tags:
        - Mapping Management
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: integer
            format: int64
          description: マッピングID
      responses:
        '204':
          description: 削除成功
        '400':
          description: 不正なIDフォーマット
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ETCDtakoMappingResponse'
        '404':
          description: マッピングが見つからない
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ETCDtakoMappingResponse'

  /api/etc/mapping/by-meisai/{meisai_id}:
    get:
      summary: ETC明細IDでマッピングを取得
      description: 指定されたETC明細IDのマッピングを取得します
      tags:
        - Mapping Management
      parameters:
        - name: meisai_id
          in: path
          required: true
          schema:
            type: integer
            format: int64
          description: ETC明細ID
          example: 12345
      responses:
        '200':
          description: マッピング一覧
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/ETCDtakoMapping'
              example:
                - id: 1
                  etc_meisai_id: 12345
                  dtako_row_id: "DT-2025-001-001"
                  vehicle_id: "V001"
                  mapping_type: "manual"
                  created_at: "2025-01-13T15:04:05Z"
        '400':
          description: 不正なIDフォーマット
          content:
            application/json:
              schema:
                type: object
                properties:
                  error:
                    type: string
                example:
                  error: "Invalid ID format"

  /api/etc/mapping/by-dtako/{dtako_row_id}:
    get:
      summary: DtakoRowIDでマッピングを取得
      description: 指定されたDtakoRowIDのマッピングを取得します
      tags:
        - Mapping Management
      parameters:
        - name: dtako_row_id
          in: path
          required: true
          schema:
            type: string
          description: DtakoRowID
          example: "DT-2025-001-001"
      responses:
        '200':
          description: マッピング一覧
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/ETCDtakoMapping'
        '400':
          description: 不正なURL
          content:
            application/json:
              schema:
                type: object
                properties:
                  error:
                    type: string

  /api/etc/mapping/list:
    get:
      summary: マッピング一覧を取得
      description: ページネーション付きでマッピング一覧を取得します
      tags:
        - Mapping Management
      parameters:
        - name: page
          in: query
          required: false
          schema:
            type: integer
            minimum: 1
            default: 1
          description: ページ番号
          example: 1
        - name: limit
          in: query
          required: false
          schema:
            type: integer
            minimum: 1
            maximum: 100
            default: 20
          description: 1ページあたりの件数
          example: 20
        - name: mapping_type
          in: query
          required: false
          schema:
            type: string
            enum: [auto, manual]
          description: マッピングタイプでフィルタ
        - name: vehicle_id
          in: query
          required: false
          schema:
            type: string
          description: 車両IDでフィルタ
        - name: created_by
          in: query
          required: false
          schema:
            type: string
          description: 作成者でフィルタ
      responses:
        '200':
          description: マッピング一覧
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ETCDtakoMappingListResponse'
              example:
                mappings:
                  - id: 1
                    etc_meisai_id: 12345
                    dtako_row_id: "DT-2025-001-001"
                    vehicle_id: "V001"
                    mapping_type: "manual"
                    created_at: "2025-01-13T15:04:05Z"
                  - id: 2
                    etc_meisai_id: 12346
                    dtako_row_id: "DT-2025-001-002"
                    vehicle_id: "V002"
                    mapping_type: "auto"
                    created_at: "2025-01-13T15:05:10Z"
                total_count: 150
                page: 1
                page_size: 20
        '500':
          description: サーバーエラー
          content:
            application/json:
              schema:
                type: object
                properties:
                  error:
                    type: string

  /api/etc/mapping/unmapped:
    get:
      summary: マッピングされていないETC明細を取得
      description: |
        マッピングがまだ作成されていないETC明細を取得します。
        自動マッピングや手動マッピングの対象となるデータの確認に使用します。
      tags:
        - Mapping Management
      parameters:
        - name: limit
          in: query
          required: false
          schema:
            type: integer
            minimum: 1
            maximum: 1000
            default: 100
          description: 取得件数
          example: 100
        - name: date_from
          in: query
          required: false
          schema:
            type: string
            format: date
          description: 利用日時の開始日（フィルタ）
          example: "2025-01-01"
        - name: date_to
          in: query
          required: false
          schema:
            type: string
            format: date
          description: 利用日時の終了日（フィルタ）
          example: "2025-01-31"
        - name: vehicle_no
          in: query
          required: false
          schema:
            type: string
          description: 車両番号でフィルタ
        - name: etc_num
          in: query
          required: false
          schema:
            type: string
          description: ETCカード番号でフィルタ
      responses:
        '200':
          description: 未紐付けETC明細一覧
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '../openapi.yaml#/components/schemas/ETCMeisai'
              example:
                - id: 12347
                  date_to: "2025-01-13T15:30:00Z"
                  etc_num: "1234567890123456"
                  price: 1000
                  ic_entry: "東京IC"
                  ic_exit: "横浜IC"
                  vehicle_no: "品川123あ4567"
                - id: 12348
                  date_to: "2025-01-13T16:45:00Z"
                  etc_num: "1234567890123457"
                  price: 800
                  ic_entry: "新宿IC"
                  ic_exit: "渋谷IC"
                  vehicle_no: "品川456い7890"
        '500':
          description: サーバーエラー
          content:
            application/json:
              schema:
                type: object
                properties:
                  error:
                    type: string

components:
  schemas:
    # ETC-Dtakoマッピング
    ETCDtakoMapping:
      type: object
      properties:
        id:
          type: integer
          format: int64
          description: マッピングID
        etc_meisai_id:
          type: integer
          format: int64
          description: ETC明細ID
        dtako_row_id:
          type: string
          description: Dtako行ID
        vehicle_id:
          type: string
          description: 車両ID
          nullable: true
        mapping_type:
          type: string
          enum: [auto, manual]
          description: マッピングタイプ
          default: manual
        notes:
          type: string
          description: 備考
          nullable: true
        created_at:
          type: string
          format: date-time
          description: 作成日時
        updated_at:
          type: string
          format: date-time
          description: 更新日時
        created_by:
          type: string
          description: 作成者
          nullable: true

    # マッピング作成リクエスト
    ETCDtakoMappingRequest:
      type: object
      required:
        - etc_meisai_id
        - dtako_row_id
      properties:
        etc_meisai_id:
          type: integer
          format: int64
          description: ETC明細ID
        dtako_row_id:
          type: string
          description: Dtako行ID
        vehicle_id:
          type: string
          description: 車両ID
          nullable: true
        mapping_type:
          type: string
          enum: [auto, manual]
          description: マッピングタイプ
          default: manual
        notes:
          type: string
          description: 備考
          nullable: true
        created_by:
          type: string
          description: 作成者
          nullable: true

    # マッピング操作レスポンス
    ETCDtakoMappingResponse:
      type: object
      properties:
        success:
          type: boolean
          description: 操作成功フラグ
        mapping:
          $ref: '#/components/schemas/ETCDtakoMapping'
          nullable: true
        message:
          type: string
          description: メッセージ

    # マッピング一覧レスポンス
    ETCDtakoMappingListResponse:
      type: object
      properties:
        mappings:
          type: array
          items:
            $ref: '#/components/schemas/ETCDtakoMapping'
          description: マッピング一覧
        total_count:
          type: integer
          description: 総件数
        page:
          type: integer
          description: 現在のページ番号
        page_size:
          type: integer
          description: ページサイズ
        has_next:
          type: boolean
          description: 次のページが存在するか
        has_prev:
          type: boolean
          description: 前のページが存在するか

tags:
  - name: Mapping Management
    description: ETC明細とDtako行のマッピング管理機能