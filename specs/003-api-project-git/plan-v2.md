# 実装計画: ETC明細Goモジュール完成（軽量版）

**ブランチ**: `003-api-project-git` | **日付**: 2025-09-18 | **仕様**: [spec.md](./spec.md)
**入力**: 機能仕様書 `/specs/003-api-project-git/spec.md`

## 実行フロー (/plan コマンドスコープ)
```
1. 機能仕様書を入力パスから読み込む
   → 見つからない場合: ERROR "No feature spec at {path}"
2. 技術コンテキストを埋める (明確化必要項目をスキャン)
   → コンテキストからプロジェクトタイプを検出
   → プロジェクトタイプに基づく構造決定
3. 憲法文書の内容に基づいて憲法チェックセクションを埋める
4. 憲法チェックセクションを評価
   → 違反が存在する場合: 複雑性追跡に文書化
   → 正当化不可能な場合: ERROR "Simplify approach first"
   → 進捗追跡を更新: 初期憲法チェック
5. フェーズ0を実行 → research.md
   → 明確化必要項目が残る場合: ERROR "Resolve unknowns"
6. フェーズ1を実行 → contracts, data-model.md, quickstart.md, CLAUDE.md
7. 憲法チェックセクションを再評価
   → 新しい違反がある場合: 設計をリファクタリング、フェーズ1に戻る
   → 進捗追跡を更新: 設計後憲法チェック
8. フェーズ2を計画 → タスク生成アプローチを記述 (tasks.mdは作成しない)
9. 停止 - /tasksコマンドの準備完了
```

**重要**: /planコマンドはステップ8で停止。フェーズ2-4は他のコマンドで実行:
- フェーズ2: /tasksコマンドがtasks.mdを作成
- フェーズ3-4: 実装実行（手動またはツールで）

## 要約
ETC明細データ取得・処理システムのGoモジュールを完成させる。主要な未実装機能（ParseCSVHandler）の実装とテストカバレッジ向上に焦点を当てる。Excel/PDF出力機能と統計生成機能は実装スコープから除外。

## 技術コンテキスト
**言語/バージョン**: Go 1.22
**主要依存**: chi (HTTPルーター), playwright-go (スクレイピング), go-sqlite3 (DB)
**ストレージ**: SQLite (ローカルファイル)
**テスト**: go test, testify
**ターゲットプラットフォーム**: Goモジュール（他プロジェクトから利用）
**プロジェクトタイプ**: single (Goライブラリ)
**パフォーマンス目標**: CSV1万行を5秒以内で処理
**制約**: メモリ使用量500MB以下、同時ダウンロード5アカウントまで
**スケール/スコープ**: 法人・個人複数アカウント、月間10万レコード処理
**除外機能**: Excel/PDF出力、統計生成機能は実装しない

## 憲法チェック
*ゲート: フェーズ0リサーチ前に必須。フェーズ1設計後に再チェック。*

### I. ドキュメント言語
- [x] 仕様書（spec.md）: 日本語で記述済み
- [x] 実装計画書（plan.md）: 日本語で記述中
- [x] リサーチドキュメント: 日本語で更新予定
- [x] データモデル定義: 日本語で更新予定
- [x] タスクリスト: 日本語で更新予定

**判定**: PASS - すべて日本語で文書化される

## プロジェクト構造

### ドキュメント (このfeature)
```
specs/003-api-project-git/
├── plan.md              # 元の計画書
├── plan-v2.md           # このファイル（更新版）
├── research-v2.md       # フェーズ0出力（更新版）
├── data-model.md        # フェーズ1出力（既存を活用）
├── quickstart.md        # フェーズ1出力（既存を活用）
├── contracts/           # フェーズ1出力（既存を活用）
└── tasks.md             # フェーズ2出力（/tasksコマンドで更新）
```

### ソースコード (リポジトリルート)
```
# Goモジュール構造（既存）
├── api.go               # ETCクライアントインターフェース
├── api_handlers.go     # HTTPハンドラー（ParseCSVHandler含む）
├── module.go            # モジュール初期化
├── services/            # ビジネスロジック層
├── repositories/        # データアクセス層
├── models/              # データモデル
├── config/              # 設定管理
├── downloads/           # CSVファイル保存先
└── tests/               # テスト
    ├── contract/        # 契約テスト（新規）
    ├── integration/     # 統合テスト（新規）
    └── unit/            # 単体テスト（新規）
```

**構造決定**: 既存のGoモジュール構造を維持

## フェーズ0: アウトライン＆リサーチ

1. **技術コンテキストから不明点を抽出**:
   - 除外機能の確認: Excel/PDF出力、統計生成を除外
   - 残る実装対象: ParseCSVHandlerのみ

2. **リサーチエージェントの生成と派遣**:
   ```
   Task: "ParseCSVHandler実装に必要な要件確認"
   Task: "multipart/form-dataでのファイルアップロード処理"
   Task: "既存のParseETCCSV関数の活用方法"
   ```

3. **調査結果を`research-v2.md`に統合**:
   - 決定: シンプルな実装に集中
   - 根拠: 既存機能の完成が優先
   - 検討した代替案: 追加機能は将来のバージョンで検討

**出力**: research-v2.md（軽量化されたスコープ）

## フェーズ1: 設計＆コントラクト
*前提条件: research-v2.md完了*

1. **既存のエンティティを確認** → `data-model.md`を活用:
   - 既存のデータモデルで十分
   - 追加エンティティは不要

2. **必要最小限のAPIコントラクトを確認**:
   - ParseCSVHandler用のインターフェース定義
   - 既存のコントラクトは維持

3. **コントラクトからテストを生成**:
   - ParseCSVHandlerのテスト作成
   - 既存機能の統合テスト追加

4. **ユーザーストーリーからテストシナリオを抽出**:
   - CSVアップロードシナリオ
   - 既存のクイックスタートガイドは有効

5. **CLAUDE.mdを更新**:
   - 除外機能を明記
   - 実装スコープの縮小を反映

**出力**: 既存ファイルの活用、CLAUDE.md更新

## フェーズ2: タスク計画アプローチ
*このセクションは/tasksコマンドが実行する内容を記述 - /plan中には実行しない*

**タスク生成戦略**:
- 実装スコープを大幅に削減
- ParseCSVHandler実装に集中
- 必要最小限のテスト追加

**タスクカテゴリー（軽量版）**:
1. **ParseCSVHandler実装** (1-2タスク)
   - ハンドラー実装
   - テスト作成

2. **既存機能のテスト強化** (3-4タスク)
   - 主要機能の統合テスト
   - エラーハンドリングのテスト

3. **パフォーマンス最適化** (2-3タスク)
   - SQLite WALモード確認
   - 既存のバルク処理最適化

**推定出力**: tasks.mdに8-10の番号付き・順序付きタスク（大幅削減）

**重要**: このフェーズは/tasksコマンドによって実行され、/planでは実行されない

## フェーズ3+: 将来の実装
*これらのフェーズは/planコマンドのスコープ外*

**フェーズ3**: タスク実行（/tasksコマンドがtasks.mdを作成）
**フェーズ4**: 実装（憲法原則に従ってtasks.mdを実行）
**フェーズ5**: 検証（テスト実行、quickstart.md実行、パフォーマンス検証）

## 複雑性追跡
*憲法チェックに違反があり正当化が必要な場合のみ記入*

| 違反 | 必要な理由 | より単純な代替案を却下した理由 |
|-----|---------|-------------------------|
| なし | - | - |

**注**: Excel/PDF出力と統計生成機能を除外することで、複雑性を大幅に削減

## 進捗追跡
*実行フロー中に更新されるチェックリスト*

**フェーズステータス**:
- [x] フェーズ0: リサーチ完了 (/planコマンド)
- [x] フェーズ1: 設計完了 (/planコマンド)
- [x] フェーズ2: タスク計画完了 (/planコマンド - アプローチ記述のみ)
- [ ] フェーズ3: タスク生成 (/tasksコマンド)
- [ ] フェーズ4: 実装完了
- [ ] フェーズ5: 検証合格

**ゲートステータス**:
- [x] 初期憲法チェック: PASS
- [x] 設計後憲法チェック: PASS
- [x] すべての明確化必要項目解決済み
- [x] 複雑性逸脱の文書化（削減により不要）

---
*憲法 v2.1.1に基づく - `/memory/constitution.md`参照*