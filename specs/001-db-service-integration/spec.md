# 機能仕様書: データベースサービス統合

**機能ID**: 001-db-service-integration
**優先度**: 高
**担当者**: Claude Code
**作成日**: 2025-09-19

## 概要

C:\go\db_service に作成されたdb-handler-serverパターンに従ったdatabase_repoを、現在のETC明細システムに統合する。
参考: https://github.com/yhonda-ohishi/db-handler-server/blob/main/README.md#handlers-repo-ビジネスロジック-grpcサーバー--クライアント

## 機能要件

### 主要機能
1. **データベースリポジトリ統合**
   - C:\go\db_service のdatabase_repoを現在のシステムに統合
   - db-handler-serverパターンの完全実装
   - 既存のSQLiteデータベース操作の移行

2. **ハンドラー統合**
   - 既存のHTTPハンドラーとdatabase_repoの連携
   - handlers/配下のファイルとrepoの統合
   - services/層からrepoへのアクセス実装

3. **互換性維持**
   - 既存APIエンドポイントの動作保証
   - 現在のデータベーススキーマとの互換性
   - 既存テストの継続動作

### 非機能要件
- **パフォーマンス**: 現在のレスポンス時間を維持
- **メモリ使用量**: 500MB以下を維持
- **データ整合性**: WALモードでのトランザクション保証

## ユーザーストーリー

### 開発者向け
1. **As a 開発者**, I want データベース操作が統一されたリポジトリパターンで実装されている so that コードの保守性が向上する

2. **As a 開発者**, I want db-handler-serverパターンに従った実装 so that 他のプロジェクトとの一貫性が保たれる

3. **As a 開発者**, I want 既存のAPIが変更なく動作する so that 既存のクライアントに影響を与えない

### システム管理者向け
1. **As a システム管理者**, I want データベース操作のログが構造化されている so that 問題の特定が容易になる

2. **As a システム管理者**, I want トランザクションが適切に管理されている so that データの整合性が保たれる

## 受け入れ基準

### 必須条件
- [ ] C:\go\db_service のdatabase_repoが正常に統合されている
- [ ] 既存のHTTPハンドラーがrepoを使用している
- [ ] 全ての既存テストが引き続き成功する
- [ ] 新しいリポジトリパターンのユニットテストが実装されている
- [ ] SQLiteのWALモードが維持されている

### 品質条件
- [ ] コードカバレッジが80%以上
- [ ] リント、タイプチェックが全て成功
- [ ] パフォーマンステストが既存レベルを維持
- [ ] セキュリティ要件（認証情報のハードコード禁止）を満たす

## 技術的制約

### 使用技術
- **言語**: Go 1.21+
- **データベース**: SQLite (WALモード)
- **アーキテクチャ**: db-handler-serverパターン
- **フレームワーク**: chi (HTTPルーティング)

### 依存関係
- 既存のmodels/パッケージとの互換性
- services/層の既存インターフェース
- handlers/配下の既存ハンドラー

### セキュリティ制約
- データベース認証情報のハードコード禁止
- 環境変数による設定管理必須
- 構造化ログによる可観測性確保

## 除外項目

- データベーススキーマの変更
- 新機能の追加
- UIの変更
- パフォーマンス最適化（現状維持）

## リスク

### 高リスク
- 既存データベース操作の互換性破損
- パフォーマンス劣化
- 既存テストの失敗

### 中リスク
- メモリ使用量の増加
- ログ出力の変更による監視への影響

### 軽減策
- 段階的な移行実装
- 既存テストの事前実行確認
- パフォーマンステストの実行

## 成功指標

1. **統合完了**: 全てのデータベース操作がrepoパターンで実装される
2. **品質維持**: 既存テストが100%成功する
3. **互換性**: 既存APIの動作が変更されない
4. **保守性**: コードの複雑度が現状以下に保たれる

## 関連ドキュメント

- [db-handler-server README](https://github.com/yhonda-ohishi/db-handler-server/blob/main/README.md)
- [CLAUDE.md](C:/go/etc_meisai/CLAUDE.md) - プロジェクトコンテキスト
- [Constitution](C:/go/etc_meisai/.specify/memory/constitution.md) - 開発原則

---
**承認者**: [未定]
**承認日**: [未定]
**バージョン**: 1.0