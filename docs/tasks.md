# ETC明細APIシステム完成タスクリスト

**プロジェクト**: ETC明細APIシステム
**ブランチ**: 003-api-project-git
**作成日**: 2025-09-19
**ベースディレクトリ**: C:/go/etc_meisai

## 概要
現在のプロジェクト状況に基づいた完全な実装タスクリスト。プロジェクトには部分的に実装されたAPIエンドポイントがあり、モデルフィールドの不一致によるコンパイルエラーが発生している。

## 優先度1: コンパイルエラー修正

### 1. モデル構造体の統一と修正
- **ファイル**: `/models/etc_meisai.go`
- **問題**: パーサーとリポジトリで参照されるフィールドが不一致
- **修正内容**:
  - `Remarks` フィールドを追加
  - `UsageType` フィールドを追加
  - `Amount` フィールドを追加（現在`TollAmount`のみ）
  - `RowID` フィールドを追加（レガシー互換性）
  - `CardNumber` フィールドエイリアスを追加

### 2. [P] パーサーのフィールドマッピング修正
- **ファイル**: `/parser/csv_parser.go`
- **問題**: `time.Time`を`string`フィールドに代入しようとしている
- **修正内容**:
  - 行102: `meisai.Date`をtime.Time型として適切に処理
  - 行111: 日付解析後の代入方法を修正
  - 行127,131: 未定義フィールド`Remarks`, `UsageType`をモデルに追加後に修正

### 3. [P] リポジトリのフィールドマッピング修正
- **ファイル**: `/repositories/etc_repository.go`
- **問題**: 未定義フィールド参照エラー
- **修正内容**:
  - `RowID`, `CardNumber`, `Amount`フィールドをモデルで定義後に参照修正
  - SQLクエリとstructフィールドの整合性確保
  - 行179-180の`Amount`フィールド参照エラー修正

### 4. SQLiteスキーマとMySQLスキーマの統一
- **ファイル**: `/schema.sql`, `/migrations/`
- **問題**: 現在のschema.sqlはMySQL構文、実際はSQLiteを使用
- **修正内容**:
  - SQLite用のスキーマ作成（AUTO_INCREMENT→AUTOINCREMENT等）
  - 適切なデータ型変換（TEXT, INTEGER等）
  - インデックス定義の修正

## 優先度2: 未実装ハンドラーの完成

### 5. [P] ParseCSVハンドラーの実装
- **ファイル**: `/handlers/parse.go`
- **機能**: CSVファイルの解析とデータベース保存
- **実装内容**:
  - ファイルアップロード処理
  - CSVパーサーとの統合
  - バルクインサート処理
  - エラーハンドリング

### 6. [P] データマッピングハンドラーの実装
- **ファイル**: `/handlers/mapping.go`
- **機能**: ETCデータとデジタコデータのマッピング
- **実装内容**:
  - 自動マッピングロジック
  - 手動マッピング機能
  - マッピング結果の保存・更新

### 7. [P] ETCデータ取得ハンドラーの実装
- **ファイル**: `/handlers/etc_handlers.go`
- **機能**: データベースからのETCデータ取得
- **実装内容**:
  - 日付範囲検索
  - 車両番号別検索
  - ページング対応
  - サマリー統計取得

### 8. インポートセッション管理の実装
- **ファイル**: `/handlers/import_handlers.go`
- **機能**: インポート履歴の管理
- **実装内容**:
  - インポートセッションの開始・終了
  - 進捗追跡
  - エラーログ記録

## 優先度3: データベース・マイグレーション

### 9. データベース初期化の実装
- **ファイル**: 新規作成 `/database/init.go`
- **機能**: データベース接続とテーブル作成
- **実装内容**:
  - SQLite接続設定（WALモード等）
  - 自動テーブル作成
  - マイグレーション実行

### 10. SQLiteマイグレーションファイルの作成
- **ディレクトリ**: `/migrations/`
- **内容**:
  - `001_create_etc_meisai_table.sql`
  - `002_create_mapping_table.sql`
  - `003_add_indexes.sql`
  - `004_add_import_sessions.sql`

### 11. [P] テストデータの準備
- **ディレクトリ**: `/testdata/`
- **内容**:
  - サンプルCSVファイル
  - テスト用データベース
  - モックデータ生成スクリプト

## 優先度4: 統合テストとAPI検証

### 12. [P] ユニットテストの作成
- **ディレクトリ**: `/tests/unit/`
- **テストファイル**:
  - `parser_test.go` - CSV解析テスト
  - `repository_test.go` - データベース操作テスト
  - `handlers_test.go` - ハンドラーテスト

### 13. [P] 統合テストの作成
- **ディレクトリ**: `/tests/integration/`
- **テストファイル**:
  - `api_test.go` - API エンドポイント全体テスト
  - `workflow_test.go` - エンドツーエンドワークフローテスト

### 14. API契約テストの実装
- **ディレクトリ**: `/tests/contract/`
- **内容**:
  - OpenAPI仕様との整合性確認
  - レスポンススキーマ検証
  - エラーレスポンス形式確認

## 優先度5: ビジネスロジック実装

### 15. ETCスクレイピングサービスの統合
- **ファイル**: `/services/scraping_service.go`
- **機能**: 実際のETCポータルからのデータ取得
- **実装内容**:
  - Playwright統合
  - 認証処理
  - データ抽出ロジック

### 16. [P] ハッシュサービスの実装
- **ファイル**: `/services/hash_service.go`
- **機能**: データ重複チェック
- **実装内容**:
  - ファイルハッシュ計算
  - 重複データスキップ
  - インクリメンタル更新

### 17. 非同期ジョブ管理の強化
- **ファイル**: `/services/job_service.go`
- **機能**: 複数アカウント並行処理
- **実装内容**:
  - ジョブキュー管理
  - 進捗追跡改善
  - エラー回復機能

### 18. [P] データ変換サービスの実装
- **ファイル**: `/services/transform_service.go`
- **機能**: データ正規化と変換
- **実装内容**:
  - フィールドマッピング
  - データクリーニング
  - バリデーション

## 優先度6: 運用・監視機能

### 19. ログ機能の強化
- **ファイル**: `/services/logging_service.go`
- **機能**: 構造化ログと監視
- **実装内容**:
  - ログレベル設定
  - 操作ログ記録
  - パフォーマンス計測

### 20. [P] ヘルスチェックの拡張
- **ファイル**: `/handlers/health.go`
- **機能**: システム状態監視
- **実装内容**:
  - データベース接続確認
  - 外部サービス疎通確認
  - メトリクス収集

### 21. 設定管理の改善
- **ファイル**: `/config/config.go`
- **機能**: 環境別設定管理
- **実装内容**:
  - 設定バリデーション
  - デフォルト値設定
  - 環境変数管理

## 優先度7: ドキュメント・デプロイ

### 22. [P] API仕様書の更新
- **ファイル**: `/docs/swagger.yaml`
- **内容**: 実装されたエンドポイントの仕様更新

### 23. [P] 運用マニュアルの作成
- **ファイル**: `/docs/operations.md`
- **内容**: デプロイ、監視、トラブルシューティング手順

### 24. [P] パフォーマンステストの実装
- **ディレクトリ**: `/tests/performance/`
- **内容**: 大量データ処理時のパフォーマンス検証

## 実行順序の注意点

1. **優先度1-2は必須**: 基本機能の動作に必要
2. **[P]マーカー**: 並行実行可能なタスク
3. **依存関係**:
   - タスク1→2,3（モデル修正→パーサー・リポジトリ修正）
   - タスク4→9,10（スキーマ統一→DB初期化）
   - タスク5-8は並行実行可能
4. **検証順序**: ユニットテスト→統合テスト→API契約テスト

## 完了基準

- [ ] 全ファイルがコンパイルエラーなしでビルド可能
- [ ] 基本的なCRUD操作が正常動作
- [ ] CSVインポート機能が動作
- [ ] APIエンドポイントが仕様通りにレスポンス
- [ ] テストスイートが全て通過
- [ ] パフォーマンス目標（CSV 1万行/5秒）を達成

---
*作成日: 2025-09-19 | 総タスク数: 24*